# Бэкенд приложения

Ссылка на Github-репозиторий с [бэкендом проекта](https://github.com/pnrf/movies-explorer-api)

## Файловая структура

- `.gitignore`
- `.editorconfig`
- `.eslintrc`
- `package.json`
- `package-lock.json`

## База данных

Для создания базы данных использована **MongoDB**.

## Схема базы данных Movies Explorer

### Модель User (Пользователь)

```javascript
{
  "_id": ObjectId,          // Уникальный идентификатор пользователя
  "name": String,           // Имя пользователя
  "email": String,          // Email пользователя
  "passwordHash": String,   // Хешированный пароль
  "movies": [ObjectId],     // Массив ссылок на фильмы (ссылки на _id в коллекции Movies)
  "createdAt": Date,        // Дата создания аккаунта
  "updatedAt": Date         // Дата последнего обновления
}
```

### Модель Movie (Фильм)

```javascript
{
  "_id": ObjectId,              // Уникальный идентификатор фильма
  "country": String,            // Страна производства
  "director": String,           // Режиссер
  "duration": Number,           // Продолжительность в минутах
  "year": Number,               // Год выпуска
  "description": String,        // Описание фильма
  "image": String,              // URL превью-изображения
  "trailerLink": String,        // URL трейлера
  "thumbnail": String,          // URL миниатюры
  "movieId": String,            // Внешний ID фильма
  "nameRU": String,             // Название на русском
  "nameEN": String,             // Название на английском
  "owner": ObjectId,            // Ссылка на пользователя (ObjectId из коллекции Users)
  "createdAt": Date,            // Дата добавления в избранное
  "updatedAt": Date             // Дата последнего обновления
}
```

### Связи между коллекциями

* **One-to-Many** (Один ко многим):
  * Один пользователь может иметь много фильмов в избранном
  * В модели User хранится массив ссылок на фильмы (`movies`)
  * В модели Movie хранится ссылка на владельца (`owner`)

### Индексы

Рекомендуется создать индексы для следующих полей:
* `email` в коллекции Users (уникальный индекс)
* `movieId` в коллекции Movies (уникальный индекс)
* `owner` в коллекции Movies (индекс для быстрого поиска фильмов пользователя)

### Дополнительные примечания

* Все даты хранятся в формате ISO Date
* Пароли хранятся в виде хешей
* Внешние ID фильмов (`movieId`) используются для предотвращения дублирования
* Все строковые поля должны проходить валидацию на соответствие формату



## API

### Схемы и модели API-ресурсов

База данных содержит 2 сущности в формате JSON:

1. `user` - зарегистрированный пользователь:

| Поле | Описание | Валидация |
| ------ | ------ | ------ |
| email | Почта пользователя. Обязательное поле, уникальное значение. | Регулярное выражение |
| password | Хеш пароля пользователя. Обязательное поле, уникальное значение. | - |
| name | Имя пользователя. Обязательное поле, неуникальное значение, 2-30 символов | - |

2. `movie`- избранный фильм:

| Поле | Описание | Значение | Обязательное поле |
| :------ | :------ | :------: | :------: |
| country | Страна создания фильма | string | да |
| director | Режиссер фильма | string | да |
| duration | Длительность фильма | number | да |
| year | Год выпуска фильма | string | да |
| description | Описание фильма | string | да |
| image | Ссылка на постер к фильму | URL | да |
| trailerLink | Ссылка на трейлер фильма | URL | да |
| thumbnail | Иконка постера к фильму | URL | да |
| owner | `_id` пользователя, добавившего фильм в избранное | - | да |
| moeieId | id фильма | number | да |
| nameRU | название фильма по-русски | string | да |
| nameEN | название фильма по-английски | string | да |

### Роуты и контроллеры

```bash 

# возвращает информацию о пользователе (email и имя)
GET /users/me

# обновляет информацию о пользователе (email и имя)
PATCH /users/me

# возвращает все сохранённые текущим пользователем фильмы
GET /movies

# создаёт фильм с переданными в теле
# country, director, duration, year, description, image, trailer, nameRU, nameEN и thumbnail, movieId 
POST /movies

# удаляет сохранённый фильм по id
DELETE /movies/_id

```

Контоллеры для каждого роута. 
Защита роута авторизацией: если пользовать не прислал JWT, доступ к роутам запрещен.

### Аутентификация и авторизация

2 дополнительных роута для регистрации и логина

```bash

# создаёт пользователя с переданными в теле
# email, password и name
POST /signup

# проверяет переданные в теле почту и пароль
# и возвращает JWT
POST /signin

```

Защита роутов авторизацией не требуется.

Внимание: если сохранять JWT в cookies, то необходим дополнительный роут `POST /signout`. При обращении к нему JWT удаляется из cookies.

### Логирование

Файлы для хранения логов:

- request.log – хранит информацию обо всех обращениях к API;
- error.log – хранит информацию об обшибках, которые возвращает API.

Логи в формате JSON. Файлы логовор в Github-репозиторий не добавляются.

## Деплой

Для размещения веб-приложения в сети необходимо:

1. Создать сервер

- Обращение к API по публичному IP-адресу.
- Разместить сервер можно в Яндекс Облаке.

2. Создать и прикрепить домен

- Зарегистрировать домен у любого регистратора доменных имен.
- Настроить DNS на стороне регистратора.
- API можно вынести на поддомен ```api.*``` или использовать префикс пути `~/api/`.

3. Установить SSL-протокол

- Выпустить и подключить SSL-сертификаты, чтобы обращаться к серверу по протоколу `https`.

4. Создать `.env`-файл на сервере

Переменные окружения:

- `NODE_ENV=production`;
- `JWT_SECRET`.

Внимание: проверить, что `.env`-файл добавлен в `.gitignore` и в репозиторий не публикуется.

